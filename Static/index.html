<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF Chat Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    :root {
      --primary: #4f46e5;
      --primary-light: #6366f1;
      --primary-dark: #4338ca;
      --accent: #818cf8;
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #0f172a;
      --text-light: #64748b;
      --border: #e2e8f0;
      --success: #10b981;
      --error: #ef4444;
    }
    
    body {
    font-family: 'Inter', sans-serif;
    background-color: var(--bg);
    color: var(--text);
    margin: 20px;
}

    
    .gradient-text {
      background: linear-gradient(90deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    
    .typing-indicator {
      display: flex;
      gap: 0.25rem;
      align-items: center;
    }
    
    .typing-dot {
      width: 0.5rem;
      height: 0.5rem;
      border-radius: 50%;
      background-color: var(--text-light);
      animation: bounce 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes bounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-0.25rem); }
    }
    
    .pdf-card {
      transition: all 0.2s ease;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .pdf-card:hover {
      background-color: #f1f5f9;
      transform: translateY(-1px);
    }
    
    .message-bubble {
      max-width: 90%;
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      line-height: 1.5;
      word-break: break-word;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .user-bubble {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      border-bottom-right-radius: 0.25rem;
      margin-left: auto;
    }
    
    .bot-bubble {
      background-color: #f8fafc;
      color: var(--text);
      border: 1px solid var(--border);
      border-bottom-left-radius: 0.25rem;
      margin-right: auto;
    }
    
    .chat-container {
      scrollbar-width: thin;
      scrollbar-color: var(--primary-light) transparent;
      height: 100%;
    }
    
    .chat-container::-webkit-scrollbar {
      width: 6px;
    }
    
    .chat-container::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .chat-container::-webkit-scrollbar-thumb {
      background-color: var(--primary-light);
      border-radius: 3px;
    }
    
    .upload-area {
      border: 2px dashed var(--border);
      transition: all 0.2s ease;
      min-height: 100px;
    }
    
    .upload-area:hover {
      border-color: var(--primary-light);
      background-color: #f8fafc;
    }
    
    .upload-area.drag-over {
      border-color: var(--primary);
      background-color: #eef2ff;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: var(--primary);
      border-radius: 50%;
      cursor: pointer;
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="min-h-screen flex items-stretch justify-stretch p-0">
  <div class="w-full h-screen grid grid-cols-1 lg:grid-cols-4 gap-4 p-0">
    <!-- Sidebar -->
    <div class="bg-white rounded-none lg:rounded-xl shadow-sm p-4 flex flex-col overflow-hidden col-span-1 h-full">
      <div class="flex items-center gap-2 mb-4">
        <i data-feather="file-text" class="text-indigo-500"></i>
        <h2 class="font-semibold text-lg gradient-text">PDF Documents</h2>
      </div>
      
      <div id="uploadArea" class="upload-area rounded-lg p-4 mb-4 cursor-pointer text-center">
        <input type="file" id="pdfUpload" accept="application/pdf" class="hidden" />
        <div class="flex flex-col items-center justify-center">
          <i data-feather="upload" class="w-8 h-8 text-indigo-400 mb-2"></i>
          <p class="text-sm text-gray-500">Drag & drop PDFs or click to upload</p>
        </div>
      </div>
      
      <div class="flex items-center gap-2 mb-2">
        <i data-feather="settings" class="text-indigo-500 w-4 h-4"></i>
        <span class="text-sm font-medium">Settings</span>
      </div>
      
      <div class="space-y-4 mb-4">
        <div>
          <label class="block text-xs text-gray-500 mb-1">Max tokens: <span id="tokenVal" class="font-medium">4096</span></label>
          <input id="maxTokens" type="range" min="2048" max="16384" step="512" value="4096" 
                 class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" />
        </div>
        
        <div>
          <label class="block text-xs text-gray-500 mb-2">Response Mode:</label>
          <div class="flex gap-4">
            <label class="flex items-center gap-2 text-sm">
              <input type="radio" name="mode" value="rag" checked class="h-4 w-4 text-indigo-600" />
              <span>RAG</span>
            </label>
            <label class="flex items-center gap-2 text-sm">
              <input type="radio" name="mode" value="chat" class="h-4 w-4 text-indigo-600" />
              <span>Chat</span>
            </label>
          </div>
        </div>
      </div>
      
      <div class="flex-1 overflow-auto">
        <div id="pdfList" class="space-y-1"></div>
      </div>
      
      <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-100">
        <button id="newChat" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-indigo-600 hover:bg-indigo-50 rounded-lg transition">
          <i data-feather="plus" class="w-4 h-4"></i>
          New Chat
        </button>
        <div id="uploadStatus" class="text-xs text-gray-400"></div>
      </div>
    </div>
    
    <!-- Main Chat Area -->
    <div class="bg-white rounded-none lg:rounded-xl shadow-sm p-0 flex flex-col col-span-3 h-full">
      <div class="flex items-center justify-between p-4 border-b border-gray-100">
        <div>
          <h1 class="font-bold text-lg">PDF Chat Assistant</h1>
          <p class="text-xs text-gray-500">Ask questions about your uploaded documents</p>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-xs text-gray-500">Status:</span>
          <span id="statusDot" class="inline-flex items-center gap-1 text-xs font-medium text-indigo-600">
            <span class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></span>
            Ready
          </span>
        </div>
      </div>
      
      <div id="chatWindow" class="chat-container flex-1 overflow-y-auto p-4 space-y-4 h-[calc(100%-120px)]">
        <div class="text-center py-8" id="emptyState">
          <i data-feather="message-square" class="w-12 h-12 mx-auto text-indigo-200 mb-4"></i>
          <h3 class="font-medium text-gray-500">Start a conversation with your PDFs</h3>
          <p class="text-sm text-gray-400 mt-1">Upload documents and ask questions</p>
        </div>
      </div>
      
      <div class="p-4 border-t border-gray-100 sticky bottom-0 bg-white">
        <div class="flex gap-3 items-end">
          <textarea id="userInput" rows="1" placeholder="Type your message here..."
            class="flex-1 px-4 py-3 rounded-lg border border-gray-200 focus:border-indigo-300 focus:ring-2 focus:ring-indigo-100 resize-none outline-none transition"
            style="min-height: 48px; max-height: 150px;"></textarea>
          <button id="sendBtn" class="flex items-center justify-center w-12 h-12 rounded-full bg-indigo-600 text-white hover:bg-indigo-700 transition">
            <i data-feather="send" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      feather.replace();
      AOS.init();
      
      const API_URL = window.location.origin;
      const userIdKey = "chat_user_id_v1";
      const userId = localStorage.getItem(userIdKey) || (Math.random() + "").slice(2);
      localStorage.setItem(userIdKey, userId);

      const chatWindow = document.getElementById("chatWindow");
      const pdfListEl = document.getElementById("pdfList");
      const uploadArea = document.getElementById("uploadArea");
      const uploadInput = document.getElementById("pdfUpload");
      const uploadStatus = document.getElementById("uploadStatus");
      const maxTokensEl = document.getElementById("maxTokens");
      const tokenVal = document.getElementById("tokenVal");
      const newChatBtn = document.getElementById("newChat");
      const userInput = document.getElementById("userInput");
      const sendBtn = document.getElementById("sendBtn");
      const emptyState = document.getElementById("emptyState");

      // Update token value display
      tokenVal.textContent = maxTokensEl.value;
      maxTokensEl.addEventListener('input', () => {
        tokenVal.textContent = maxTokensEl.value;
      });

      // Upload area interactions
      uploadArea.addEventListener('click', () => uploadInput.click());
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
      });
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('drag-over');
      });
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
        if (e.dataTransfer.files.length) {
          uploadInput.files = e.dataTransfer.files;
          handleUpload();
        }
      });
      uploadInput.addEventListener('change', handleUpload);

      async function handleUpload() {
        const file = uploadInput.files[0];
        if (!file) return;
        
        if (file.type !== "application/pdf") {
          showUploadStatus("Please upload a PDF file", false);
          return;
        }

        showUploadStatus("Uploading...", true);
        const fd = new FormData();
        fd.append("file", file);
        
        try {
          const res = await fetch(`${API_URL}/upload_pdf`, { 
            method: "POST", 
            body: fd 
          });
          
          const data = await res.json();
          if (data.error) {
            showUploadStatus(data.error, false);
          } else {
            showUploadStatus(`Uploaded (${data.chunks} chunks)`, true);
            loadPDFs();
          }
        } catch (e) {
          showUploadStatus("Upload failed", false);
          console.error("Upload error:", e);
        }
      }

      function showUploadStatus(message, isSuccess) {
        uploadStatus.textContent = message;
        uploadStatus.className = isSuccess ? "text-xs text-green-500" : "text-xs text-red-500";
        setTimeout(() => {
          uploadStatus.textContent = "";
        }, 5000);
      }

      // Load PDF list
      async function loadPDFs() {
        try {
          const res = await fetch(`${API_URL}/pdfs`);
          const data = await res.json();
          pdfListEl.innerHTML = "";
          
          if (data.files && data.files.length > 0) {
            data.files.forEach((file, index) => {
              const fileItem = document.createElement('div');
              fileItem.className = 'flex items-center justify-between p-2 rounded-lg pdf-card hover:bg-gray-50 cursor-pointer';
              fileItem.innerHTML = `
                <label class="flex items-center gap-2 w-full cursor-pointer">
                  <input type="checkbox" name="selectedPDF" value="${file}" class="h-4 w-4 text-indigo-600 rounded">
                  <div class="flex items-center gap-2">
                    <i data-feather="file-text" class="w-4 h-4 text-indigo-400"></i>
                    <span class="text-sm truncate max-w-[180px]">${file}</span>
                  </div>
                </label>
                <button data-file="${file}" class="delete-btn p-1 text-gray-400 hover:text-red-500">
                  <i data-feather="trash-2" class="w-4 h-4"></i>
                </button>
              `;
              pdfListEl.appendChild(fileItem);
            });
            feather.replace();
            
            // Add delete event listeners
            document.querySelectorAll('.delete-btn').forEach(btn => {
              btn.addEventListener('click', async (e) => {
                e.stopPropagation();
                const filename = btn.getAttribute('data-file');
                if (confirm(`Are you sure you want to delete ${filename}?`)) {
                  try {
                    const res = await fetch(`${API_URL}/delete_pdf`, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ filename })
                    });
                    const result = await res.json();
                    if (result.success) {
                      loadPDFs();
                    } else {
                      alert('Failed to delete file');
                    }
                  } catch (error) {
                    console.error('Delete error:', error);
                  }
                }
              });
            });
          } else {
            pdfListEl.innerHTML = `
              <div class="text-center py-4 text-sm text-gray-400">
                <i data-feather="folder" class="w-5 h-5 mx-auto mb-2"></i>
                <p>No documents uploaded yet</p>
              </div>
            `;
            feather.replace();
          }
        } catch (e) {
          console.error("Failed to load PDFs", e);
        }
      }

      // New chat
      newChatBtn.addEventListener('click', async () => {
        if (chatWindow.children.length > 1 && !confirm('Are you sure you want to start a new chat?')) {
          return;
        }
        
        chatWindow.innerHTML = `
          <div class="text-center py-8" id="emptyState">
            <i data-feather="message-square" class="w-12 h-12 mx-auto text-indigo-200 mb-4"></i>
            <h3 class="font-medium text-gray-500">Start a conversation with your PDFs</h3>
            <p class="text-sm text-gray-400 mt-1">Upload documents and ask questions</p>
          </div>
        `;
        feather.replace();
        
        try {
          await fetch(`${API_URL}/reset`, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URL
          });
        } catch (e) {
          console.error("Reset error:", e);
        }
      });

      // Send message
      sendBtn.addEventListener('click', sendMessage);
      userInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Auto-resize textarea
      userInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
      });

      async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;
        
        // Remove empty state if present
        if (emptyState) emptyState.remove();
        
        // Show user message
        addMessage(text, "user");
        userInput.value = "";
        userInput.style.height = '48px';
        
        // Show typing indicator
        const typingIndicator = addTypingIndicator();
        
        // Gather selected PDFs and settings
        const selected = Array.from(document.querySelectorAll('input[name="selectedPDF"]:checked')).map(i => i.value);
        const mode = document.querySelector('input[name="mode"]:checked').value;
        
        try {
          const res = await fetch(`${API_URL}/chat`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              user_id: userId,
              message: text,
              mode,
              memory_size: 1,
              context_window_size: 650,
              pdfs: selected,
              max_tokens: parseInt(maxTokensEl.value, 10)
            })
          });

          if (!res.ok) {
            const errorText = await res.text();
            replaceTypingWithMessage("[Error] " + errorText, typingIndicator);
            return;
          }

          // Handle streaming response
          if (!res.body) {
            replaceTypingWithMessage("[Error] No response body", typingIndicator);
            return;
          }

          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          let done = false;
          let fullResponse = "";
          
          while (!done) {
            const { value, done: doneReading } = await reader.read();
            done = doneReading;
            if (value) {
              const chunk = decoder.decode(value, { stream: true });
              fullResponse += chunk;
              replaceTypingWithMessage(fullResponse, typingIndicator);
              chatWindow.scrollTop = chatWindow.scrollHeight;
            }
          }
        } catch (err) {
          console.error("Chat error:", err);
          replaceTypingWithMessage("[Error] " + (err.message || "Failed to get response"), typingIndicator);
        }
      }

      function addMessage(text, sender = "bot") {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'fade-in';
        
        const bubble = document.createElement('div');
        bubble.className = sender === "user" 
          ? 'message-bubble user-bubble' 
          : 'message-bubble bot-bubble';
        bubble.textContent = text;
        
        messageDiv.appendChild(bubble);
        chatWindow.appendChild(messageDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        return messageDiv;
      }

      function addTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'flex fade-in';
        
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble bot-bubble';
        
        const typing = document.createElement('div');
        typing.className = 'typing-indicator';
        typing.innerHTML = `
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        `;
        
        bubble.appendChild(typing);
        typingDiv.appendChild(bubble);
        chatWindow.appendChild(typingDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        return typingDiv;
      }

  function replaceTypingWithMessage(text, typingElement) {
  if (!typingElement) return;

  const bubble = typingElement.querySelector('.message-bubble');
  if (bubble) {
    bubble.className = 'message-bubble bot-bubble';

    // Format basic Markdown (headings, bold, italic, code, lists)
// Format basic Markdown (headings, bold, italic, code, lists)
let formatted = text
  .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>') // code blocks
  .replace(/`([^`]+)`/g, '<code>$1</code>') // inline code
  .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // bold
  .replace(/\*(.*?)\*/g, '<em>$1</em>') // italic
  // Headings
  .replace(/^### (.*)$/gim, '<h3>$1</h3>')
  .replace(/^## (.*)$/gim, '<h2>$1</h2>')
  .replace(/^# (.*)$/gim, '<h1>$1</h1>')
  // Bullet lists
  .replace(/^- (.*)$/gim, '<li>$1</li>');

// Group consecutive <li> items into a single <ul>
formatted = formatted.replace(/(<li>[\s\S]*?<\/li>)/gim, '<ul>$1</ul>');
formatted = formatted.replace(/<\/ul>\s*<ul>/g, ''); // merge adjacent <ul>

// Convert numbered "Sources" into <ol><li>
formatted = formatted.replace(
  /Sources:(?:\s*\d+\.\s.*(?:\n|$))+/g,
  match => {
    // Extract each numbered item
    const items = match
      .replace("Sources:", "")
      .trim()
      .split(/\d+\.\s/)
      .filter(Boolean)
      .map(item => `<li>${item.trim()}</li>`)
      .join("\n");

    return `<h3>Sources</h3><ol>${items}</ol>`;
  }
);

// Convert double line breaks into paragraphs
formatted = formatted.replace(/([^\n<>]+)\n\n/g, '<p>$1</p>');



    bubble.innerHTML = formatted;
            }
          }


      // Initialize
      loadPDFs();
        });
</script>
</body>
</html>